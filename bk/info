# ndb-cluster-openshift
ubuntu 18

## 1º) Nas maquinas individuais, todas, atualizar todo o sistema;
sudo apt update
sudo apt upgrade 
sudo apt dist-upgrade 

## Se pedir para atualizar o menu do Grub, escolha 
"install the package mantainer's verision"


##-------- DATA-NODES -----------------------------------------------########

## files 
mysql-cluster-community-data-node_8.0.20-1ubuntu18.04_amd64.deb
## dependencias para ser instalada 
libclass-methodmaker-perl
## data dir
	/usr/local/mysql/data
## config files
	/etc/my.cnf
### execução
	iniciar os serviços 

##-------- MYSQL-NODES ----------------------------------------------#########

## files 
mysql-client_8.0.20-1ubuntu18.04_amd64.deb
mysql-cluster-community-client_8.0.20-1ubuntu18.04_amd64.deb
mysql-cluster-community-client-core_8.0.20-1ubuntu18.04_amd64.deb
mysql-cluster-community-server_8.0.20-1ubuntu18.04_amd64.deb
mysql-cluster-community-server-core_8.0.20-1ubuntu18.04_amd64.deb
mysql-common_8.0.20-1ubuntu18.04_amd64.deb
mysql-server_8.0.20-1ubuntu18.04_amd64.deb
## dependencias a serem instaladas
libaio1 libmecab2
## config files 
	/etc/mysql/my.cnf

##-------- NDB-MANAGEMENT -------------------------------------------############

## files 
mysql-cluster-community-management-server_8.0.20-1ubuntu18.04_amd64.deb
## data dir
	/usr/mysql-cluster
## config files 
	config.ini
## execução
	iniciar os serviços
## -----------------------------------------------------------------------

## PASSO A PASSO 

## Instalar em todos os nós menos o de MGMT (Gerenciamento)
sudo apt install libclass-methodmaker-perl libaio1 libmecab2

## Em todos os nós, menos o management, pra instalar todos os .deb
sudo dpkg -i *.deb

## Depois disso, o Banco Mysql já deve estar disponivel para acesso via terminal

## Agora no Management instalar o ndb-management
sudo dpkg -i mysql-cluster-community-management-server_8.0.20-1ubuntu18.04_amd64.deb

## Nos NODES o arquivo abaixo é relacionado ao DATA-NODES, crie 
nano /etc/my.cnf  

## adicione o conteúdo abaixo
[mysql_cluster]
ndb-connectstring=******ip do server********

## Após isso, se tentar executar ndbd, o node informa que não pode conectar a string nodeid=ip_management

## nos DATA-NODES crie e pasta abaixo
mkdir -p /usr/mysql-cluster  

## Instalar os serviços do ndbd
sudo vim /etc/systemd/system/ndbd.service

## E adiciona o conteudo abaixo
[Unit]
Description=MySQL NDB Data Node Daemon
After=network.target audit.service

[Service]
Type=forking
ExecStart=/usr/sbin/ndbd
ExecReload=/bin/kill -HUP $MAINPID
KillMode=process
Restart=on-failure

[Install]
WantedBy=multi-user.target

## Executa os comandos abaixo para ativar o auto-start 
sudo systemctl enable ndbd
sudo systemctl daemon-reload

## Para criar os API-MYSQL Nodes 
## Criar o arquivo 
sudo nano /etc/mysql/my.cnf

## E adiciona o conteúdo abaixo 
[mysqld]
ndbcluster
ndb-connectstring=******ip do server********

[mysql_cluster]
ndb-connectstring=******ip do server********

###### Configurações no MANAGEMENT
mkdir -p /usr/mysql-cluster/config.ini
## E Adiciona o conteúdo abaixo
[ndbd default]
NoOfReplicas=2

[ndbd_mgmd]
hostname=*******ip do server*******
datadir=/usr/mysql-cluster
NodeId=1

[ndbd]
hostname=*********ip do Nó 1*********
NodeId=11
datadir=/usr/local/mysql/data

[ndbd]
hostname=*********ip do Nó 2*********
NodeId=12
datadir=/usr/local/mysql/data

[mysqld]
hostname=*********ip do Nó 1*********
NodeId=21

[mysqld]
hostname=*********ip do Nó 2*********
NodeId=22

## Criar o arquivo 
sudo vim /etc/systemd/system/ndb_mgmd.service

## E adiciona o conteúdo abaixo
[Unit]
Description=MySQL NDB Cluster Management Server
After=network.target audit.service

[Service]
Type=forking
ExecStart=/usr/sbin/ndb_mgmd -f /usr/mysql-cluster/config.ini
ExecReload=/bin/kill -HUP $MAINPID
KillMode=process
Restart=on-failure

[Install]
WantedBy=multi-user.target

## E depois executa 
sudo systemctl enable ndb_mgmd
sudo systemctl daemon-reload

## E inicia o Management com o comando abaixo
sudo ndb_mgmd --initial --config-file=/usr/mysql-cluster/config.ini

## Agora vai nos NODES e executa ndb_mgm -e show e ele vai mostrar que o 
## Management já está ativo 

## E para conectar os DATA-NODES ao management basta digitar
ndbd

## e para conectar os MYSQL-NODES ao managemnt basta reiniciar o server mysql com
sudo service mysql restart

## Com isso, ambos os nós DATA-NODES quanto MYSQL-NODES já estarão conectados ao management
## E ao executar o comando ndb_mgm -e show provavelmente já estarão conectados todos os nós

########## COMANDOS UTEIS ########################################################
nbd_mgm -e show -> List all clusters 
ndb -> start the node
pkill ndbd -> End process nodes 
pkill ndb_mgmd -> Finaliza do Management

sudo ndb
sudo pkill ndb
sudo ndb_mgm -e show 

